<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>采购开单</title>
    <link rel="stylesheet" type="text/css" href="../../css/ui-base.css">
    <link rel="stylesheet" type="text/css" href="../../css/layer.css">
    <link rel="stylesheet" type="text/css" href="../../css/mobiscroll.2.13.2.min.css">
    <link rel="stylesheet" type="text/css" href="../../css/public.css">
    <link rel="stylesheet" type="text/css" href="../../css/enhance_index.css">
</head>
<body class="uhide">
    <header class="ub ub-pc ub-ac module-header-t1 bg-fixed2 line-b">
        <a id="backBtn" class="ub ub-ac">
            <div class="icon back-icon-wh"></div>
            <div class="tx-16 tx-wh">返回</div>
        </a>
        <div id="pageTitle" class="ub-f1 ub ub-ac ub-pc tx-18">采购开单</div>
        <div class="ub ub-ac ub-pe title-r">
            <a id="listBtn" class="icon list-icon-wh"></a>
            <div id="submitBtn" class="icon post-icon-wh marl-10"></div>
        </div>
    </header>
    <div class="mart-5 padt-44">
        <section class="ub ub-ver marb-5 bg-wh line-t line-b">
            <div class="padlr-15 bg-f8-active">
                <div class="ub ub-ac ub-f1 h-44 line-b">
                    <div class="item-tilte itemName tx-l tx-bla">日期</div>
                    <div class="ub ub-ac ub-f1 tx-r tx-gray">
                        <input id="billDate" data-kname="billdate" class="billInput ub-f1 tx-r ut-s" type="text" readonly>
                    </div>
                </div>
            </div>
            <div class="padlr-15">
                <div class="ub ub-ac ub-f1 h-44 line-b">
                    <div class="item-tilte itemName tx-l tx-bla ">单号</div>
                    <div class="ub ub-ac ub-f1 tx-r tx-gray">
                        <input id="billCode" data-kname="billcode" class="billInput ub-f1 tx-r ut-s" type="text">
                    </div>
                </div>
            </div>
            <div class="padlr-15 bg-f8-active">
                <div class="ub ub-ac ub-f1 h-44 line-b">
                    <div class="item-tilte parr-5 tx-l tx-bla">单据类型</div>
                    <label for="billkindName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
                        <div class="ub-f1"></div>
                        <select id="billkindName" data-kid="billkind" data-kname="billkindname" class="hide sel-opt"></select>
                        <div class="rightArrow"></div>
                    </label>
                </div>
            </div>
            <div id="chooseTraderBtn" class="padlr-15 bg-f8-active">
                <div class="ub ub-ac ub-f1 h-44 line-b">
                    <div id="customType" class="item-tilte itemName tx-l tx-bla">供应商</div>
                    <div class="ub ub-ac ub-f1 tx-r tx-gray">
                        <input id="traderName" data-kid="traderid" data-kname="tradername" class="billInput ub-f1 tx-r" type="text" readonly>
                        <div class="rightArrow"></div>
                    </div>
                </div>
            </div>
            <div class="padlr-15 bg-f8-active">
                <div class="ub ub-ac ub-f1 h-44">
                    <div class="item-tilte itemName tx-l tx-bla">发票类型</div>
                    <label for="billkindName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
                        <div class="ub-f1"></div>
                        <select id="notetypeName" data-kid="notetype" data-kname="notetypename" class="hide sel-opt"></select>
                        <div class="rightArrow"></div>
                    </label>
                </div>
            </div>
        </section>

        <section class="ub ub-ver marb-5 bg-wh line-t line-b">
            <div id="toggleBtn" class="ub-f1 ub ub ub-ac ub-pc h-44 bg-f8-active line-b" data-on="1">
                <div id="toggleIcon" class="icon-upArrow"></div>
                <span id="toggleTip" class="tx-gra">收起</span>
            </div>
            <div id="toggleCon">
                <div class="padlr-15">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div class="item-tilte itemName tx-l tx-bla ">币种</div>
                        <div class="ub ub-ac ub-f1 tx-r tx-gray">
                            <input id="moneyName" data-kid="moneyid" data-kname="moneyname" class="billInput ub-f1 tx-r ut-s" type="text" readonly>
                        </div>
                    </div>
                </div>
                <div class="padlr-15">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div id='paytheod' class="item-tilte itemName tx-l">本次现付</div>
                        <div class="ub ub-ac ub-f1 tx-r tx-gray">
                            <input id="payMent" data-kname="payamt" class="billInput ub-f1 tx-r ut-s" type="text" value="0.00">
                        </div>
                    </div>
                </div>
                <div class="padlr-15">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div class="item-tilte parr-5 tx-l tx-gray">结算方式</div>
                        <label for="ctraderType" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
                            <div class="ub-f1"></div>
                            <select id="ctraderType" data-kid="paymethodid" data-kname="paymethodname" class="hide sel-opt" disabled="false">
                                <option data-id=""></option>
                            </select>
                            <div class="rightArrow"></div>
                        </label>
                    </div>
                </div>
                <div class="padlr-15">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div class="item-tilte parr-5 tx-l tx-gray">结算帐户</div>
                        <label for="settleAccount" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
                            <div class="ub-f1"></div>
                            <select id="settleAccount" data-kid="accountid" data-kname="accountname" class="hide sel-opt" disabled="false">
                                <option data-id=""></option>
                            </select>
                            <div class="rightArrow"></div>
                        </label>
                    </div>
                </div>
                <div id="chooseSettleUnitBtn" class="padlr-15 bg-f8-active" data-on="1">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div class="item-tilte itemName tx-l tx-bla">结算单位</div>
                        <div class="ub ub-ac ub-f1 tx-r tx-gray">
                            <input id="ctraderComp" data-kid="ctraderid" data-kname="ctradername" class="billInput ub-f1 tx-r" type="text" readonly>
                            <div class="rightArrow"></div>
                        </div>
                    </div>
                </div>
                <div class="padlr-15 bg-f8-active">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div class="item-tilte itemName tx-l tx-bla">项目</div>
                        <label for="projectName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
                            <div class="ub-f1"></div>
                            <select id="projectName" data-kid="projectid" data-kname="projectname" class=" sel-opt">
                                <option data-id="" selected></option>
                            </select>
                            <div class="rightArrow"></div>
                        </label>
                    </div>
                </div>
                <div class="padlr-15 bg-f8-active">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div class="item-tilte itemName tx-l tx-bla">部门</div>
                        <label for="depName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
                            <div class="ub-f1"></div>
                            <select id="depName" data-kid="departmentid" data-kname="depname" class="hide sel-opt">
                                <option data-id="" selected></option>
                            </select>
                            <div class="rightArrow"></div>
                        </label>
                    </div>
                </div>
                <div class="padlr-15 bg-f8-active">
                    <div class="ub ub-ac ub-f1 h-44 line-b">
                        <div class="item-tilte itemName tx-l tx-bla">业务员</div>
                        <label for="empName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
                            <div class="ub-f1"></div>
                            <select id="empName" data-kid="empid" data-kname="empname" class="hide sel-opt">
                                <option data-id="" selected></option>
                            </select>
                            <div class="rightArrow"></div>
                        </label>
                    </div>
                </div>
            </div>
        </section>
        <section class="ub ub-ver marb-5 bg-wh line-t line-b">
            <div id="chooseGoodsBtn" class="padlr-15 bg-f8-active" data-on="1">
                <div class="ub ub-ac ub-f1 h-44 line-b">
                    <div class="item-tilte itemName tx-l tx-bla">选择货品</div>
                    <div class="ub ub-ac ub-pe ub-f1 tx-r tx-gray">
                        <div class="rightArrow"></div>
                    </div>
                </div>
            </div>
            <div id="listDetail"></div>
            <div class="padlr-15">
                <div class="ub-f1 ub ub-ac h-44">
                    <div class="itemName tx-l tx-bla">合计</div>
                    <div class=" ub-f1 ut-s tx-r tx-bla bold">
                        <span id="moneyCode">￥</span><span id="amount" class="hide"></span><span id="amountStr">0</span>
                    </div>
                </div>
            </div>
        </section>
        <div id="delBtn" class="longButton danger ub-f1 hide">删&nbsp;除</div>
    </div>
</body>
<script type="text/javascript" src="../../js/sea.js"></script>
<script type="text/javascript" src="../../js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="../../js/enhance_index.js"></script>
<script>
    seajs.use(['zepto.min', 'public', 'save', 'layer', 'mobiscroll.2.13.2.min'], function (zepto, _Public, save_order) {
        var enhance_index = new Enhance_index();
        /**
         * 接收传递参数
         */
        var type = enhance_index.checkType(enhance_index.getPageParams('type') || '');//请求模式
        var action = enhance_index.getPageParams('action') || '';//操作模式
        var billId = enhance_index.getPageParams('billId') || '';//单据id

        //修改地址
        var prevDetailPageName = sessionStorage.getItem('session_prevDetailPageName') || '';
        if (prevDetailPageName != enhance_index.detailPageName[type]) {
            // console.log('detailPageName：' + enhance_index.detailPageName[type]);
            sessionStorage.removeItem('session_billDataJson');
            sessionStorage.removeItem('session_temp_billDataJson');//临时编辑数据缓存
            sessionStorage.removeItem('session_traderJson');//（联动数据）供应商/客户/结算单位
            sessionStorage.setItem('session_prevDetailPageName', enhance_index.detailPageName[type]);
        }
        //修改参数
        var prevBillAction = sessionStorage.getItem('session_prevBillAction') || '';
        if (prevBillAction != action) {
            // console.log('action：' + action);
            sessionStorage.removeItem('session_billDataJson');
            sessionStorage.removeItem('session_temp_billDataJson');//临时编辑数据缓存
            sessionStorage.removeItem('session_traderJson');//（联动数据）供应商/客户/结算单位
            sessionStorage.setItem('session_prevBillAction', action);
        }
        //修改单据id
        if (action == 'edit' && billId != '' && billId != sessionStorage.getItem('session_billId')) {
            // console.log('修改单据id');
            sessionStorage.removeItem('session_temp_billDataJson');//临时编辑数据缓存
            sessionStorage.removeItem('session_traderJson');//（联动数据）
        }

        /**
         * 初始化页面组件
         */
        //页面标题
        var pageTitle = enhance_index.detailPageTitle[type];
        $('#pageTitle').text(pageTitle);
        document.title = pageTitle;
        //表单标题
        $('#customType').text(enhance_index.getTraderTilte[type]);//根据不同类型的单据获取标题(供应商/客户)
        $('#paytheod').text(enhance_index.getPaytheodTilte[type]);//根据不同类型的单据获取标题(本次现付/本次现收)
        //展开收起
        $('#toggleBtn').on('tap', function (event) {
            event.preventDefault();
            var dataOn = $(this).data('on');
            if (dataOn == '0') {
                $('#toggleCon').removeClass('hide');
                $('#toggleIcon').removeClass('icon-down');
                $('#toggleTip').text('收起');
                $(this).data('on', '1');
            } else {
                $('#toggleCon').addClass('hide');
                $('#toggleIcon').addClass('icon-down')
                $('#toggleTip').text('展开详细信息');
                $(this).data('on', '0');
            }
        });

        /**
         * 操作参数
         */
        var prevBillDate = $('#billDate').val();//记住当前的日期

        /**
         * 传递参数
         */
        var vipID = 0;
        var canEditPrice = true;//是否能够修改货品单价

        /**
         * 请求参数
         */
        var ipUrl = 'http://' + _Public.Get_storage('sdIP');//接口IP
        var editUrl = ipUrl + enhance_index.billEditUrl[type];//编辑接口地址
        var addUrl = ipUrl + enhance_index.billAddUrl[type];//添加接口地址
        var delUrl = ipUrl + enhance_index.billDelUrl[type];//删除接口地址
        var saveUrl = ipUrl + enhance_index.billSaveUrl[type];//保存接口地址
        var master_backup = {};//页面数据备份变量
        var isAdd = true;//是否为新增模式

        /**
         * 数据处理
         */
        if (action == 'edit') {
            /*
            * 编辑模式
            */
            isAdd = false;
            enhance_index.offMobiscroll($('#billkindName'));//单据类型不可用
            if (billId != '' && billId != sessionStorage.getItem('session_billId') || !sessionStorage.getItem('session_temp_billDataJson') && billId != '') {
                sessionStorage.setItem('session_billId', billId);
                console.log('edit-new');
                //输入参数
                var dataStr = {
                    'billId': billId
                }
                //设置参数
                var dataCommand = enhance_index.DataCommand(editUrl, 'post', dataStr);
                //发送请求，返回数据
                dataCommand.init(
                    function (ret) {
                        if (ret.errNo) {
                            //提示错误信息弹窗
                            _Public.hideProgress();
                            if(ret.errMsg=='单据已被删除或不存在!'){
                                sessionStorage.setItem('session_billAction', 'add');
                                window.location.href = 'order_frame.html?&type='+type;
                            }
                            _Public.closeToLogin(ret.errMsg);
                        } else {
                            sessionStorage.removeItem('session_prevTraderId');
                            sessionStorage.removeItem('session_billDataJson');
                            /**
                             * 货品需要参数
                             */
                            var rdetail1 = ret.detail1;
                            for (var k = 0; k < rdetail1.length; k++) {
                                ret.detail1[k].log_oldGoods = 'true';
                                ret.detail1[k].log_attr = 'old';
                                ret.detail1[k].log_id = k;
                            }
                            sessionStorage.setItem('session_billDataJson', JSON.stringify(ret));
                            succFuncEdit(ret);
                            getSelectData();
                        }
                    }, function (ret) {
                        _Public.hideProgress();
                        _Public.layerMsg(ret.msg);
                    }
                );
            } else if (sessionStorage.getItem('session_temp_billDataJson')) {
                console.log('edit-old');
                var rets = sessionStorage.getItem('session_temp_billDataJson') || '';
                // console.log(rets);
                rets = JSON.parse(rets);
                succFuncEdit(rets);
                getSelectData();
            } else if (sessionStorage.getItem('session_billDataJson') && billId == '') {
                // console.log(0);
            } else {
                // console.log(1);
            }
        } else if (action == 'add') {
            /*
             * 新增模式
             */
            if (sessionStorage.getItem('session_temp_billDataJson')) {
                console.log('add-old');
                var rets = sessionStorage.getItem('session_temp_billDataJson') || '';
                // console.log(rets);
                rets = JSON.parse(rets);
                succFuncEdit(rets);
                getSelectData();
            } else {
                console.log('add-new');
                //设置参数
                var dataCommand = enhance_index.DataCommand(addUrl, 'post');
                //发送请求，返回数据
                dataCommand.init(
                    function (ret) {
                        if (ret.errNo) {
                            //提示错误信息弹窗
                            _Public.closeToLogin(ret.errMsg);
                        } else {
                            sessionStorage.removeItem('session_prevTraderId');
                            sessionStorage.removeItem('session_billDataJson');
                            sessionStorage.setItem('session_billDataJson', JSON.stringify(ret));
                            /**
                             * 货品需要参数
                             */
                            vipID = ret.master.vipid;//主表中会员的值
                            succFuncAdd(ret);
                            getSelectData();
                        }
                    }, function (ret) {
                        _Public.hideProgress();
                        _Public.layerMsg(ret.msg);
                    }
                );
            }
            //单据下拉选择改变事件
            $('#billkindName').on('change', function () {
                //删除所有的商品HTML
                $('#listDetail').empty();
                //总价归零
                $('#amount').text(0);
                $('#amountStr').text(0);
            });
            $('#delBtn').addClass('hide');//隐藏按钮
        }else{
            $('html').empty();
            console.log('err');
        }

        /**
         * 初始化页面事件
         */
        //后退
        $('#backBtn').on('tap', function () {
            if (action == 'edit') {
                window.location.href = enhance_index.listPageName[type]+'?type='+type;
            } else if (action == 'add') {
                window.location.href = './index.html';
            } else {
                history.back();
            }
        });
        //进入列表按钮
        $('#listBtn').on('tap', function () {
            sessionStorage.setItem('session_billAction', 'add');
            window.location.href = 'billing_frame.html?type='+type;
        });
        //点击进入选择商品页面
        $('#chooseGoodsBtn').on('tap', function (event) {
            event.preventDefault();
            /**
             * 货品选择需要参数
             */
            //是否在采购开单中单据类型是否为采购退货
            var isPurReturn = 0;
            var billKind = $('#billkindName').data('id');//单据类型
            if(type=='pbilling' && billKind=='2' && enhance_index.getMobiscrollValue($('#billkindName'))=='采购退货'){
                isPurReturn = 1;
            }
            if ($(this).data('on') == '1') {
                var goodParamJson = {
                    'billKind': $('#billkindName').data('id') || 1,//单据类型id
                    'traderID': $('#traderName').data('id') || 0,//客户或/供应商id
                    'traderTaxRate': $('#traderName').data('taxrate') || 0,//客户或/供应商的税率
                    'isRetrun': 1,
                    'billDate': $('#billDate').val(),
                    'noteType': $('#notetypeName').data('id') || 1,//发票类型
                    'billType': enhance_index.billtype[type],
                    'isPurReturn': isPurReturn,//是否为采购退货（单据类型）
                    'vipID': vipID,
                    'canEditPrice': canEditPrice,//是否能够修改货品单价
                }
                enhance_index.tempSessionStorage();//临时缓存
                sessionStorage.setItem('session_prevTraderId', $('#traderName').data('id') || '');//设置下次对比供应商/客户是否改变session
                sessionStorage.setItem('session_goodParamJson', JSON.stringify(goodParamJson));
                window.location.href = './pro_choose.html?type=' + type;
            }
        });
        //点击进入商品详情页面
        $(document).on('tap', '.goodsItem', function (event) {
            event.preventDefault();
            /**
             * 货品选择需要参数
             */
            //是否在采购开单中单据类型是否为采购退货
            var isPurReturn = 0;
            var billKind = $('#billkindName').data('id');//单据类型
            if(type=='pbilling' && billKind=='2' && enhance_index.getMobiscrollValue($('#billkindName'))=='采购退货'){
                isPurReturn = 1;
            }
            var goodParamJson = {
                'billKind': billKind,//单据类型id
                'traderID': $('#traderName').data('id') || 0,//客户或/供应商id
                'traderTaxRate': $('#traderName').data('taxrate') || 0,//客户或/供应商的税率
                'isRetrun': 1,
                'billDate': $('#billDate').val(),
                'noteType': $('#notetypeName').data('id') || 1,//发票类型
                'billType': enhance_index.billtype[type],
                'isPurReturn': isPurReturn,//是否为采购退货（单据类型）
                'vipID': vipID,
                'canEditPrice': canEditPrice,//是否能够修改货品单价
            }
            enhance_index.tempSessionStorage();//临时缓存
            sessionStorage.setItem('session_prevTraderId', $('#traderName').data('id') || '');//设置下次对比供应商/客户是否改变session
            sessionStorage.setItem('session_goodParamJson', JSON.stringify(goodParamJson));
            var goodsDataJson = $(this).attr('data-json');
            sessionStorage.setItem('goodsData', goodsDataJson);
            //货品是否可编辑
            var act = action;
            if(action == 'add'){
                act = 'edit';
            }
            window.location.href = './pro_edit.html?type=' + type + '&act='+act;
        });
        //选择供应商/客户
        $('#chooseTraderBtn').on('tap', function (event) {
            event.preventDefault();
            //如果不是审核状态可选
            if (action != 'check') {
                var billAction = action;
                if (action == 'check') {
                    billAction = 'edit';
                }
                sessionStorage.setItem('session_prevTraderId', $('#traderName').data('id') || '');//设置下次对比供应商/客户是否改变session
                sessionStorage.setItem('session_billAction', billAction);
                enhance_index.tempSessionStorage();//临时缓存
                window.location.href = './trader_choose.html?type=' + type;
            }
        });
        //选择结算单位
        $('#chooseSettleUnitBtn').on('tap', function (event) {
            event.preventDefault();
            if ($(this).data('on') == '1') {
                var billAction = action;
                if (action == 'check') {
                    billAction = 'edit';
                }
                sessionStorage.setItem('session_prevTraderId', $('#traderName').data('id') || '');//设置下次对比供应商/客户是否改变session
                sessionStorage.setItem('session_billAction', billAction);
                if (action != 'check') {
                    enhance_index.tempSessionStorage();//临时缓存
                    window.location.href = './trader_choose.html?type=' + type + '&chooseType=settleUnit';
                }
            }
        });

        /**
         * 联动事件
         */
        //初始化下拉选择框
        $('select').on('change', function () {
            enhance_index.change_select($(this));
        });
        //日期联动单号
        $('#billDate').on('change', function(){
            var dataJson = {
                'billType': ''+enhance_index.billtype[type],
                'billDate': $('#billDate').val(),
                'oldBillDate': prevBillDate,
                'oldBillCode': $('#billCode').val()
            }
            enhance_index.getBillCodeByDate($('#billCode'), dataJson);
            prevBillDate = $('#billDate').val();
        });
        //本次现付
        $('#payMent').on('change', function () {
            if ($(this).val() != 0) {
                //四舍五入保留两位小数点
                var nowPay = Number($(this).val());
                nowPay = nowPay.toFixed(2);
                $(this).val(nowPay);
                //结算方式可用
                enhance_index.onMobiscroll($('#ctraderType'));
                //结算账户可用
                enhance_index.onMobiscroll($('#settleAccount'));
                //将供应商设置为结算单位
                enhance_index.setValue($('#ctraderComp'), $('#traderName').val());//结算单位
                $('#ctraderComp').data('id', $('#traderName').data('id'));//结算单位id
                //结算单位不可用
                enhance_index.offSelectPageBtn($('#chooseSettleUnitBtn'));
            } else {
                $(this).val('0.00');
                //结算方式不可用
                enhance_index.offMobiscroll($('#ctraderType'));
                document.getElementById('ctraderType').options[0].selected = true;
                $('#ctraderType').data('id', '');
                //结算账户不可用
                enhance_index.offMobiscroll($('#settleAccount'));
                document.getElementById('settleAccount').options[0].selected = true;
                $('#settleAccount').data('id', '');
                //不为现金往来单位时
                if($('#traderName').data('iscashtrader')=='0'){
                    //结算单位可用
                    enhance_index.onSelectPageBtn($('#chooseSettleUnitBtn'));
                }
            }
        });
        //发票类型
        $('#notetypeName').on('change', function (event) {
            event.preventDefault();
            change_notetypeName();
        });
        //员工/业务员联动部门
        $('#empName').on('change', function () {
            $('#depName').prev('input').val($(this).data('departmentname'));//部门
            $('#depName').data('id', $(this).data('departmentid'));//部门id
        });
        //结算方式联动结算账户
        $('#ctraderType').on('change', function(event){
            event.preventDefault();
            var accountname = $(this).data('accountname');
            var accountid = $(this).data('accountid');
            var accountshopid = $(this).data('accountshopid');
            if(accountid!=='' && accountname!='' && accountshopid==localStorage.getItem('shopID')){
                enhance_index.setMobiscrollValue($('#settleAccount'), accountname);//账户
                enhance_index.setMobiscrollId($('#settleAccount'), accountid);//账户id
            }
        });
        //发票类型联动税率
        function change_notetypeName(){
            console.log($('.goodsItem').length);
            if ($('.goodsItem').length > 0) {
                var noteType = $('#notetypeName').data('id');
                console.log(noteType);
                var taxrate = enhance_index.getTaxrate[type](noteType);
                var billAmount = 0;
                $('.goodsItem').each(function (index, el) {
                    if (typeof (taxrate) != 'undefined') {
                        billAmount += enhance_index.setDetailFromTaxrate($(el), taxrate);//总价
                    } else if (typeof (taxrate) == 'undefined' && type == 'sbilling') {
                        //销售开单
                        var goodsData = JSON.parse($(el).attr('data-json'));
                        var thisTaxRate = goodsData['goodstaxrate'];
                        var goodsReferbillid = goodsData['referbillid'];
                        var goodsTaxrate = goodsData['taxrate'];
                        if (goodsReferbillid !== '' &&goodsReferbillid!==null&& goodsTaxrate !==0) {
                            thisTaxRate = goodsTaxrate;
                        }
                        if (thisTaxRate === ''||thisTaxRate===null) {
                            thisTaxRate = localStorage.getItem('accsetTaxRate');//全局税率
                        }
                        billAmount += enhance_index.setDetailFromTaxrate($(el), thisTaxRate);//总价
                    } else if (typeof (taxrate) == 'undefined' && type == 'pbilling') {
                        //采购开单
                        var thisTaxRate = $('#traderName').data('taxrate');
                        console.log(thisTaxRate);
                        if (typeof (thisTaxRate) == 'undefined' || typeof (thisTaxRate) == 'null' || thisTaxRate == 'null' || thisTaxRate=='') {
                            thisTaxRate = 0;
                        }
                       alert(thisTaxRate);
                        billAmount += enhance_index.setDetailFromTaxrate($(el), thisTaxRate);
                    }
                });
                var amountNum = billAmount.toFixed(2);
                enhance_index.change_amount($('#amount'), amountNum);//价格改变颜色修改事件
                enhance_index.setText($('#amount'), amountNum || '0');//合计(价格)
                enhance_index.setText($('#amountStr'), amountNum || '0');//合计(价格)
            }
        }

        //成功处理函数
        function succFuncAdd(ret) {
            //初始化html模板
            // console.log(JSON.stringify(ret));
            if (ret.master && ret.detail1) {
                //把master的数据备份，保存时使用
                master_backup = enhance_index.getBilling_master(ret.master, type);
                /**
                 * 设置页面参数
                 */
                prevBillDate = ret.master.billdate || _Public.getDates().sDate;
                _Public.selectDates($('#billDate'), prevBillDate);//日期
                enhance_index.setValue($('#billCode'), ret.master.billcode || '');//单号
                enhance_index.setValue($('#moneyName'), '人民币');//币种
                $('#moneyName').data('id','0');//币种id
                enhance_index.setMobiscrollId($('#notetypeName'), 3);//发票类型id
                enhance_index.setMobiscrollValue($('#notetypeName'), '增值税发票');//发票类型
                enhance_index.offMobiscroll($('#ctraderType'));//结算方式不可用
                enhance_index.offMobiscroll($('#settleAccount'));//结算账户不可用
                _Public.hideProgress();
            }
        }
        function succFuncEdit(ret) {
            //初始化html模板
            var htmlCommand = enhance_index.HtmlCommand(goodsListHtml);
            /*主单据*/
            var rmaster = ret.master || '';
            var rdetail1 = ret.detail1 || '';
            if (rmaster != '') {
                //把master的数据备份，保存时使用
                master_backup = enhance_index.getBilling_master(rmaster, type);

                //判断多级审核||权限||单据状态
                var rresultData = ret.resultData;
                var isMutiCheck = rresultData.mutiCheck && (rmaster.checkorid!=='' && rmaster.checkorid!==null);//多级审核账套
                var isModifySelfBill = rresultData.modifySelfBill==false && rmaster.opid !== Number(localStorage.getItem('opID'));//总部操作员（没有权限）
                var isDiscard = rmaster.billstate == 2;//作废（单据状态）
                var isFinished = rmaster.finished == 1;//完成（单据状态）
                if(isMutiCheck || isModifySelfBill || isDiscard || isFinished){
                    /**
                     * 多级审核/没有权限/完成状态
                     */
                    action = 'check';//货品状态
                    enhance_index.readPattern();//阅读模式
                    enhance_index.offDatePicker($('#billDate'));//日期选择器不可用
                    enhance_index.offSelectPageBtn($('#chooseSettleUnitBtn'));//结算单位不可用
                    enhance_index.offSelectPageBtn($('#chooseGoodsBtn'));//选择货品不可选
                    $('#submitBtn').remove();//去除保存按钮
                }else{
                    if(!ret.resultData.canEditDateCode){
                        enhance_index.offDatePicker($('#billDate'));//日期选择器不可用
                        $('#billCode').attr('readonly', 'true');//单号不可用
                    }
                    canEditPrice = ret.resultData.canEditPPrice;//是否能否编辑货品单价
                    /**
                     * 未完成状态
                     */
                    if (rmaster.billstate == 1) {
                        /**
                         * 审核状态
                         */
                        action = 'check';//货品状态
                        enhance_index.readPattern();//阅读模式
                        enhance_index.offDatePicker($('#billDate'));//日期选择器不可用
                        enhance_index.offSelectPageBtn($('#chooseSettleUnitBtn'));//结算单位不可用
                        enhance_index.offSelectPageBtn($('#chooseGoodsBtn'));//选择货品不可选
                    } else {
                        /**
                         * 未审核状态
                         */
                        //显示删除按钮
                        $('#delBtn').removeClass('hide');
                        //删除操作
                        $('#delBtn').on('tap', function (event) {
                            event.preventDefault();
                            _Public.confirmLayer('确定删除该单据', function () {
                                _Public.showLoading();
                                var delDataStr = {
                                    'billId': billId,
                                    'checkStep': 0,
                                    'id': billId
                                }
                                var delDataCommand = enhance_index.DataCommand(delUrl, 'post', dataStr);
                                //发送请求，返回数据
                                delDataCommand.init(
                                    function (ret) {
                                        if (ret.errNo) {
                                            //提示错误信息弹窗
                                            _Public.hideProgress();
                                            _Public.closeToLogin(ret.errMsg);
                                        } else {
                                            _Public.hideProgress();
                                            enhance_index.layerMsg('删除成功!');
                                        }
                                    }, function (ret) {
                                        _Public.hideProgress();
                                        enhance_index.layerMsg(ret.msg);
                                    }
                                );
                            }, function () {
                                layer.close();
                                _Public.hideProgress();
                            });
                        });
                    }
                }
                /**
                 * 货品需要参数
                 */
                vipID = rmaster.vipid;//主表中会员的值
                /**
                 * 设置页面参数
                 */
                prevBillDate = ret.master.billdate || _Public.getDates().sDate;
                _Public.selectDates($('#billDate'), prevBillDate);//日期
                enhance_index.setValue($('#billCode'), rmaster.billcode || '');//单号
                enhance_index.setMobiscrollValue($('#billkindName'), rmaster.billkindname);//单据类型
                enhance_index.setMobiscrollId($('#billkindName'), rmaster.billkind);//单据类型id
                //如果是非（收发货/退货的）单据类型，不可编辑保存
                if(rmaster.billkind!=1 && rmaster.billkind!=2){
                    $('#billkindName').append('<option selected>'+ rmaster.billkindname +'</option>');//显示不能选择的单据类型
                    enhance_index.offDatePicker($('#billDate'));//日期选择器不可用
                    enhance_index.readPattern();//阅读模式
                    action = 'check';//货品不可编辑
                    $('#submitBtn').remove();
                }

                //发票类型
                enhance_index.setMobiscrollId($('#notetypeName'), rmaster.notetype || 3);//发票类型id
                enhance_index.setMobiscrollValue($('#notetypeName'), rmaster.notetypename || '增值税发票');//发票类型

                enhance_index.setValue($('#traderName'), rmaster.tradername);//供应商/客户
                enhance_index.setMobiscrollId($('#traderName'), rmaster.traderid);//供应商id/客户id
                //供应商税率/客户税率
                //销售：从货品资料里面去，如果货品资料的税率为空的情况下，从账套选项取
                //采购：取供应商税率，为空时取0
                $('#traderName').data('taxrate', rmaster.tradertaxrate || 0);

                enhance_index.setValue($('#moneyName'), rmaster.moneyname);//币种
                enhance_index.setMobiscrollId($('#moneyName'), rmaster.moneyid);//币种id

                //外币单据，移动端应只能查看不能修改保存数据
                if(rmaster.moneyid==2 && rmaster.moneyname == '美元'){
                    enhance_index.offDatePicker($('#billDate'));//日期选择器不可用
                    enhance_index.offCheckboxBtn($('#closed'));//中止按钮不可用
                    enhance_index.readPattern();//阅读模式
                    action = 'check';//货品不可编辑
                    $('#submitBtn').remove();
                }

                enhance_index.setValue($('#payMent'), rmaster.payamt || '0.00');//本次支付
                enhance_index.setValue($('#ctraderComp'), rmaster.ctradername);//结算单位
                $('#ctraderComp').data('id', rmaster.ctraderid);//结算单位id

                //判断价格正负数
                var amountStr = (rmaster.amount || '').toString();
                if(amountStr.indexOf('-')!=-1){
                    $('#amount').parent().addClass('tx-red');
                    $('#amount').parent().removeClass('tx-bla');
                    amountStr = amountStr.substring(1, amountStr.length);
                }
                enhance_index.setText($('#amount'), rmaster.amount || '0');//合计(价格)
                enhance_index.setText($('#amountStr'), amountStr  || '0');//合计(价格)

                //是否为现金往来单位
                $('#traderName').data('iscashtrader', rmaster.iscashtrader);//是否为现金往来单位
                if (rmaster.iscashtrader == 1) {
                    $('#payMent').trigger('change');
                    //现金往来单位，结算单位不可用
                    enhance_index.offSelectPageBtn($('#chooseSettleUnitBtn'));//结算单位不可用
                    $('#payMent').val($('#amount').text());//采购开单、销售开单引用现金往来单位时，本次现收/现付自动取单据的总金额
                }

                //判断本次支付是否为0
                if (rmaster.payamt && rmaster.payamt != 0) {
                    enhance_index.setMobiscrollId($('#ctraderType'), rmaster.paymethodid);//结算方式id
                    enhance_index.setMobiscrollValue($('#ctraderType'), rmaster.paymethodname);//结算方式
                    enhance_index.setMobiscrollId($('#settleAccount'), rmaster.accountid);//结算账户id
                    enhance_index.setMobiscrollValue($('#settleAccount'), rmaster.accountname);//结算账户

                    enhance_index.offSelectPageBtn($('#chooseSettleUnitBtn'));//结算单位不可用
                    enhance_index.onMobiscroll($('#ctraderType'));//结算方式可用
                    enhance_index.onMobiscroll($('#settleAccount'));//结算账户可用
                } else {
                    enhance_index.offMobiscroll($('#ctraderType'));//结算方式不可用
                    enhance_index.offMobiscroll($('#settleAccount'));//结算账户不可用
                }

                enhance_index.setMobiscrollId($('#projectName'), rmaster.projectid);//项目id
                enhance_index.setMobiscrollValue($('#projectName'), rmaster.projectname);//项目
                enhance_index.setMobiscrollId($('#depName'), rmaster.departmentid);//部门id
                enhance_index.setMobiscrollValue($('#depName'), rmaster.depname);//部门
                enhance_index.setMobiscrollId($('#empName'), rmaster.empid);//业务员id
                enhance_index.setMobiscrollValue($('#empName'), rmaster.empname);//业务员
                enhance_index.setText($('#moneyCode'), rmaster.moneycode || '￥');//币种符号

                /**
                 * 隐藏参数
                 */
                //隐藏参数（联动）
                $('#traderName').data('linkman', rmaster.linkman || '');//送货人/收货人
                $('#traderName').data('tel1', rmaster.contactphone || '');//电话
                $('#traderName').data('fax', rmaster.contactfax || '');//传真
                $('#traderName').data('billto', rmaster.billto || '');//到货地点
                $('#traderName').data('shiptype', rmaster.shiptype || '');//运输方式id
                $('#traderName').data('shiptypename', rmaster.shiptypename || '');//运输方式
                $('#traderName').data('scamt', rmaster.scamt || '');//供应商欠款/客户欠款
                $('#traderName').data('termdays', rmaster.termdays || 0);//付款期限/收款期限
                $('#traderName').data('vipid', rmaster.vipid || '');//会员卡号id
                // $('#traderName').data('cardcode', rmaster.cardcode || '');//会员卡号
                $('#traderName').data('point', rmaster.lastpoint || '');//会员卡积分
                //隐藏参数（不联动）
                $('#traderName').data('paydate', rmaster.paydate || '');//收款日期/付款日期
                $('#traderName').data('linkmanid', rmaster.linkmanid || '');//联系人id
                $('#traderName').data('linkmanname', rmaster.linkmanname || '');//联系人
                $('#traderName').data('credcode', rmaster.credcode || '');//凭证号

                //货品明细
                if (rdetail1 != '' && rdetail1 instanceof Array) {
                    for (var k = 0; k < rdetail1.length; k++) {
                        rdetail1[k].moneycode = rmaster.moneycode;
                        //将数据填充到HTML模板
                        htmlCommand.set(rdetail1[k]);
                    }
                    htmlCommand.appendIn($('#listDetail'));
                }

                var prevTraderId = sessionStorage.getItem('session_prevTraderId') || '';//上个供应商id/客户id
                // //供应商/客户是否改变
                if(Number(prevTraderId) != $('#traderName').data('id')){
                    if(prevTraderId != ''){
                        //将供应商设置为结算单位
                        $('#ctraderComp').data('id', $('#traderName').data('id'));
                        $('#ctraderComp').val($('#traderName').val());


                        //选择了现金往来单位(供应商)，结算单位不可修改
                        if($('#traderName').data('iscashtrader')=='1'){
                            enhance_index.offSelectPageBtn($('#chooseSettleUnitBtn'));//结算单位不可用
                            $('#payMent').val($('#amount').text());//采购开单、销售开单引用现金往来单位时，本次现收/现付自动取单据的总金额
                            $('#payMent').trigger('change');
                        }else{
                            enhance_index.onSelectPageBtn($('#chooseSettleUnitBtn'));//结算单位可用
                            $('#payMent').trigger('change');
                        }
                        var departmentid = $('#depName').data('id');

                        //清掉单据明细中的引单记录（referbillid不为空）
                        if($('.goodsItem').length>0){
                            var thisAmount = 0;
                            var newDetail1Array = [];
                            $('.goodsItem').each(function(){
                                var goodsData = JSON.parse($(this).attr('data-json'));
                                var referbillid = goodsData['referbillid'];
                                if(referbillid !=='' && referbillid !==null){
                                    console.log($(this).data('log_attr'));
                                    if($(this).data('log_attr')=='old'){
                                        console.log('hide');
                                        //编辑商品
                                        thisAmount += Number($(this).find('.goodsTaxprece').text());
                                        $(this).data('log_attr', 'del');
                                        newDetail1Array.push(detail1Json[k]);
                                        $(this).addClass('hide');
                                    }else{
                                        console.log('del');
                                        //新增商品
                                        thisAmount += Number($(this).find('.goodsTaxprece').text());
                                        $(this).remove();
                                    }
                                }
                            });
                            //减少价格
                            var amount = Number($('#amount').text());
                            amount = enhance_index.subtr(amount, thisAmount);
                            $('#amount').text(amount);//总价
                            $('#amountStr').text(amount);//总价
                            //价格改变颜色改变事件
                            enhance_index.change_amount($('#amountStr'), amount);

                            //收款期限联动收款日期
                            var termdays = Number($('#traderName').data('termdays')) || 0;
                            $('#traderName').data('paydate', enhance_index.getNewDay($('#billDate').val(), termdays));

                            if(newDetail1Array.length>0){
                                var session_temp_billDataJson = sessionStorage.getItem('session_temp_billDataJson') || '';
                                $.extend(ret.detail1, newDetail1Array);
                                ret.detail1 = $.extend([], []);
                                sessionStorage.setItem('session_temp_billDataJson', JSON.stringify(ret));
                            }
                        }

                    }
                    change_notetypeName();//触发发票类型改变事件
                }

                //修改供应商、客户时，清掉单据明细中的引单记录
                // var detail1Json = ret.detail1;
                // var newDetail1Array = [];
                // var thisAmount = 0;//需要减的价格
                // for (var k = 0; k < detail1Json.length; k++) {
                //     detail1Json[k].moneycode = rmaster.moneycode;
                //     var referbillid = rdetail1[k].referbillid;//引单记录
                //     if(referbillid !='' && referbillid !=null){
                //         thisAmount = enhance_index.accAdd(thisAmount, detail1Json[k].amount);
                //         if(detail1Json[k].log_attr == 'old'){
                //             //编辑货品
                //             detail1Json[k].log_attr = 'del';
                //             newDetail1Array.push(detail1Json[k]);
                //             htmlCommand.set(detail1Json[k]);
                //         }
                //     }
                // }
                // htmlCommand.appendIn($('#listDetail'));
                // //减少价格
                // var amount = Number($('#amount').text());
                // amount = enhance_index.subtr(amount, thisAmount);
                // ret.amount = amount;
                // $('#amount').text(amount);//总价
                // $('#amountStr').text(amount);//总价
                // //价格改变颜色改变事件
                // enhance_index.change_amount($('#amountStr'), amount);
                // //触发发票类型改变事件
                // change_notetypeName();
                // var session_temp_billDataJson = sessionStorage.getItem('session_temp_billDataJson') || '';
                // ret.detail1 = $.extend([{}], [{}]);
                // $.extend(ret.detail1, newDetail1Array);
                // sessionStorage.setItem('session_temp_billDataJson', JSON.stringify(ret));
                // sessionStorage.setItem('session_prevTraderId', $('#traderName').data('id'));
            }
        }  
        /**
         * 初始化下拉选择数据
         */
        function getSelectData(){
            enhance_index.getBaseData($('#billkindName'), 'pbilling', 'billKind');//单据类型
            enhance_index.getBaseData($('#notetypeName'), 'noteType', 'base');//发票类型
            enhance_index.getBaseData($('#ctraderType'), 'ctraderType', 'CtraderType');//结算方式
            enhance_index.getBaseData($('#settleAccount'), 'settleAccount', 'base');//结算账户
            enhance_index.getBaseData($('#projectName'), 'project', 'project');//项目
            enhance_index.getBaseData($('#depName'), 'department', 'base');//部门
            enhance_index.getBaseData($('#empName'), 'employ', 'employ');//业务员
        }
        // HTML模板
        function goodsListHtml(json) {
            var thisItem = $('<div></div>');
            var jsonStr = JSON.stringify(json);
            var moneycode = json.moneycode || '';
            if (json.log_attr != 'del') {
                thisItem.append($('<div class="goodsItem ub ub-ac line-b bg-f8-active oldGoods" data-attr="' + json.log_attr + '" data-id="' + json.log_id + '" data-oldGoods="' + json.log_oldGoods + '"><div class="itemName tx-bla ub ub-f1 ub-ver "><div class="marb-5 ub ub-f1 ub-pc"><div class="ub-f1 tx-l">' + json.goodscode + ' ' + json.goodsname + '</div><div class="ub-f1 tx-gra tx-r">' + json.unitquantity +'' +(json.unitname || '')+'</div></div><div class="tx-gray tx-12 ub ub-f1"><div class="ub-f1 tx-l"><span>单价：' + moneycode + '</span><span>' + json.unitprice + '</span></div><div class="ub-f1 tx-c"><span>税率：</span><span class="goodsTaxrate">' + json.taxrate + '</span><span>%</span></div><div class="ub-f1 tx-r"><span>金额：</span><span class="goodsTaxprece">' + json.amount + '</span></div></div></div></div>').attr('data-json', jsonStr));
            }
            return thisItem.html();
        }

        //单据保存
        $('#submitBtn').on('tap', function (event) {
            if (action == 'check') {
                _Public.layerMsg('该单据已被其他操作员审核！');

            } else {
                _Public.showLoading();
                //开单类中,master表的备份
                save_order.masterSave(master_backup, type);
                var STARTDATE= localStorage.getItem('STARTDATE');//开账日期
                var currDate= localStorage.getItem('currDate');//进销存期间
                var currAccDate= localStorage.getItem('currAccDate');//会计期间
                var  billdate=master_backup['master.billdate'];
                var billDataJsonMaster = JSON.parse(sessionStorage.getItem('billDataJson'));
                var trader_id = billDataJsonMaster.master.traderid || 0;//供应商id/客户id初始参数
                var billtype_id = billDataJsonMaster.master.notetype || 0;//发票类型id初始参数
                if(_Public.save_compareDate(billdate,STARTDATE)){
                    _Public.hideProgress();
                    _Public.layerMsg("不能录入开帐日期之前发生的业务，不能保存数据！");
                    return;
                }

                if(_Public.save_compareDate(billdate,currDate)){
                    _Public.hideProgress();
                    _Public.layerMsg("本单日期在当前进销存期间之前，不能保存对本单所做的修改！");
                    return;
                }
                if(_Public.save_compareDate(billdate,currAccDate)){
                   _Public.hideProgress();
                   _Public.layerMsg("本单日期在当前会计期间之前，不能保存对本单所做的修改!");
                    return;
                }
                var detail_backup = {};//货品的信息备份
                var delCount = 0;//删除货品的条数
                var edit_addCount = 0;//编辑或新增的货品条数
                var cur_detailcount = 0;//表示现在选中的货品条数
                var oldCount = 0;//表示未改动的货品条数
                $('.goodsItem').each(function (index) {
                    var statusAttr = $(this).data('attr');
                    var d = $(this).attr('data-json');
                    var detail = JSON.parse(d);
                    if (typeof (detail.validdates) == 'object')
                        if (JSON.stringify(detail.validdates) == '{}')
                            detail.validdates = '0';

                    if (detail.validdates == null)
                        detail.validdates = '0';
                    switch (statusAttr) {
                        case 'new':
                            enhance_index.getBilling_detail(detail_backup, detail, edit_addCount, type, 'detail1', false, true);
                            edit_addCount++;
                            cur_detailcount++;
                            break;
                        case 'edit':
                            enhance_index.getBilling_detail(detail_backup, detail, edit_addCount, type, 'detail1', true, false);
                            edit_addCount++;
                            cur_detailcount++;
                            break;
                        case 'del':
                            enhance_index.getBilling_detail(detail_backup, detail, delCount, type, 'deletedetail1', true, false);
                            delCount++;
                            break;
                        case 'old':
                            oldCount++;
                            break;
                        default:
                            break;
                    }
                });
                //但没对货品进行操作时，要模拟一条编辑过的货品数据
                if (JSON.stringify(detail_backup) == "{}") {
                    $('.goodsItem').each(function (index) {
                        var d = $(this).attr('data-json');
                        var detail = JSON.parse(d);
                        if (typeof (detail.validdates) == 'object')
                            if (JSON.stringify(detail.validdates) == '{}')
                                detail.validdates = '0';

                        if (detail.validdates == null)
                            detail.validdates = '0';
                        enhance_index.getBilling_detail(detail_backup, detail, edit_addCount, type, 'detail1', true, false);
                        edit_addCount++;
                        cur_detailcount++;
                        return;
                    });
                }
                //当货品的数目为0时，提示用户添加货品
                if (cur_detailcount == 0 && oldCount == 0) {
                    _Public.hideProgress();
                    _Public.layerMsg("请选择商品,再进行保存！");
                    return;
                }
                if (master_backup['master.traderid'] == null || master_backup['master.traderid'] == '') {
                    _Public.hideProgress();
                    _Public.layerMsg(enhance_index.getTraderTilte[type] + "不能为空！");
                    return;
                }
                master_backup['detail1Count'] = edit_addCount;
                master_backup['deletedetail1Count'] = delCount;
                master_backup['addnewFlag'] = isAdd;
                master_backup['startIndex'] = 0;
                master_backup['checkStep'] = 0;
                master_backup['isH5'] = true;
                if (isAdd) {
                    //当为新增开单据时
                    master_backup['billId'] = -9999;
                    master_backup['master.shopid']=localStorage.getItem('shopID');
                    master_backup['master.shopname']=localStorage.getItem('shopName');
                    master_backup['master.opname']=localStorage.getItem('opName');

                }
                master_backup['master.billid'] = master_backup['billId'];
                $.extend(master_backup, detail_backup);
                var data = {};
                data['url'] = saveUrl;
                data['data'] = master_backup;
                console.log(JSON.stringify(master_backup));
                save_order.save(data, 'purchase_billing');
            }
        })

    });
</script>
</html>